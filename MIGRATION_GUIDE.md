# Руководство по миграции: Добавление истории диалогов

## Для существующих пользователей проекта

Если вы уже использовали этот проект ранее, следуйте этим шагам для обновления:

## Шаг 1: Обновление зависимостей Backend

```bash
# Установите новую зависимость
pip install 'sqlalchemy>=2.0.29,<2.0.36'

# Или обновите все зависимости
pip install -r requirements.txt
```

## Шаг 2: Проверка работы базы данных

Запустите тестовый скрипт для проверки:

```bash
python test_database.py
```

Вы должны увидеть:
```
✅ Все тесты пройдены успешно!
📊 База данных создана: conversations.db
```

## Шаг 3: Обновление Frontend зависимостей

```bash
cd frontend
npm install
```

## Шаг 4: Запуск обновленного приложения

### Backend:
```bash
# Из корневой директории
uvicorn src.server:app --reload
```

### Frontend:
```bash
cd frontend
npm run dev
```

## Что изменилось?

### Backend
- ✅ Добавлена база данных SQLite для хранения диалогов
- ✅ Новые API эндпоинты для работы с историей
- ✅ Автоматическая инициализация БД при запуске

### Frontend
- ✅ Боковая панель с историей диалогов
- ✅ Автоматическое сохранение всех сообщений
- ✅ Возможность загрузки и удаления диалогов
- ✅ Генерация уникального User ID

## Обратная совместимость

Все существующие функции работают как прежде:
- ✅ Вопросы и ответы
- ✅ Генерация квизов
- ✅ Генерация заданий
- ✅ Экспорт диалогов в Excel

Новая функциональность добавлена без изменения существующего API.

## Структура новых файлов

```
src/
  database.py       # Модели базы данных
  crud.py           # CRUD операции

frontend/src/
  components/
    ConversationHistory.tsx  # Боковая панель с историей

conversations.db    # База данных (создается автоматически)
```

## Возможные проблемы

### Ошибка: "ModuleNotFoundError: No module named 'sqlalchemy'"
**Решение**: Установите SQLAlchemy:
```bash
pip install 'sqlalchemy>=2.0.29,<2.0.36'
```

### Ошибка: "Cannot find module 'zustand/middleware'"
**Решение**: Переустановите зависимости frontend:
```bash
cd frontend
rm -rf node_modules package-lock.json
npm install
```

### База данных не создается
**Решение**: Проверьте права доступа к директории:
```bash
ls -la conversations.db
# Если файл не существует, запустите сервер заново
```

### Диалоги не сохраняются
**Решение**: 
1. Проверьте консоль браузера на ошибки
2. Убедитесь, что backend запущен
3. Проверьте, что CORS настроен правильно

## Откат изменений

Если вы хотите вернуться к предыдущей версии без истории диалогов:

```bash
# Удалите базу данных
rm conversations.db

# Откатите изменения в git (если используете)
git checkout HEAD~1

# Переустановите зависимости
pip install -r requirements.txt
cd frontend && npm install
```

## Дополнительная информация

- Подробная документация: [CONVERSATION_HISTORY.md](CONVERSATION_HISTORY.md)
- Список изменений: [CHANGES_SUMMARY.md](CHANGES_SUMMARY.md)
- Основная документация: [README.md](README.md)

## Поддержка

При возникновении проблем:
1. Проверьте логи сервера
2. Проверьте консоль браузера
3. Убедитесь, что все зависимости установлены
4. Попробуйте запустить тестовый скрипт: `python test_database.py`
