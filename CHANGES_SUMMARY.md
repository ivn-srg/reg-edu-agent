# Сводка изменений: Система сохранения истории диалогов

## Обзор
Реализована полная система сохранения и управления историей переписок пользователей с ботом. Все диалоги автоматически сохраняются в базу данных SQLite и доступны для просмотра через боковую панель.

## Новые файлы

### Backend
1. **`src/database.py`** - Модели базы данных и настройка SQLAlchemy
   - Модель `Conversation` для хранения диалогов
   - Модель `Message` для хранения сообщений
   - Функции инициализации БД

2. **`src/crud.py`** - CRUD операции для работы с диалогами
   - Создание, чтение, обновление, удаление диалогов
   - Управление сообщениями

### Frontend
3. **`frontend/src/components/ConversationHistory.tsx`** - Компонент боковой панели с историей
   - Список всех диалогов пользователя
   - Возможность выбора, удаления и создания диалогов
   - Адаптивный дизайн для мобильных устройств

### Документация
4. **`CONVERSATION_HISTORY.md`** - Подробная документация системы
5. **`CHANGES_SUMMARY.md`** - Этот файл

## Измененные файлы

### Backend
1. **`src/server.py`**
   - Добавлена инициализация базы данных
   - Добавлены новые эндпоинты для работы с историей:
     - `POST /conversations` - создание диалога
     - `GET /conversations/{id}` - получение диалога
     - `GET /users/{user_id}/conversations` - список диалогов
     - `DELETE /conversations/{id}` - удаление диалога
     - `POST /messages` - добавление сообщения
     - `GET /conversations/{id}/messages` - получение сообщений
     - `PUT /conversations/{id}/title` - обновление заголовка
   - Добавлены новые Pydantic модели для API

2. **`requirements.txt`**
   - Добавлена зависимость `sqlalchemy==2.0.23`

### Frontend
3. **`frontend/src/api/client.ts`**
   - Добавлены методы для работы с API истории диалогов
   - Добавлены TypeScript интерфейсы для данных

4. **`frontend/src/store/chatStore.ts`**
   - Добавлено состояние `currentConversationId`
   - Добавлено состояние `userId` с автогенерацией
   - Добавлен метод `createNewConversation()`
   - Добавлен метод `saveMessageToDb()`
   - Добавлен метод `loadConversation()`
   - Добавлен метод `setCurrentConversationId()`
   - Интегрирован Zustand persist middleware

5. **`frontend/src/types/index.ts`**
   - Расширен интерфейс `ChatState` новыми полями и методами

6. **`frontend/src/components/ChatInput.tsx`**
   - Добавлена автоматическая создание диалога при первом сообщении
   - Добавлено сохранение каждого сообщения в БД
   - Интегрированы методы работы с диалогами из store

7. **`frontend/src/App.tsx`**
   - Добавлен компонент `ConversationHistory` в layout
   - Изменена структура layout для размещения боковой панели

## Функциональность

### Автоматическое сохранение
- При отправке первого сообщения автоматически создается новый диалог
- Каждое сообщение (пользователя и ассистента) сохраняется в БД
- Время последнего обновления диалога обновляется при каждом новом сообщении

### Управление диалогами
- **Просмотр истории**: Боковая панель со списком всех диалогов
- **Загрузка диалога**: Клик по диалогу загружает все его сообщения
- **Удаление диалога**: Возможность удалить любой диалог с подтверждением
- **Новый диалог**: Кнопка для начала нового диалога

### Пользовательский опыт
- Каждому пользователю присваивается уникальный ID (хранится в localStorage)
- Диалоги группируются по типу (вопрос/квиз/задание)
- Отображается дата последнего обновления и количество сообщений
- Адаптивный дизайн с выдвижной панелью на мобильных устройствах

## База данных

### Структура
- **База данных**: SQLite (`conversations.db` в корне проекта)
- **Таблицы**:
  - `conversations` - диалоги пользователей
  - `messages` - сообщения в диалогах

### Связи
- Один диалог может содержать много сообщений (One-to-Many)
- Каскадное удаление: при удалении диалога удаляются все его сообщения

## Технологический стек

### Backend
- FastAPI - веб-фреймворк
- SQLAlchemy - ORM для работы с БД
- SQLite - база данных
- Pydantic - валидация данных

### Frontend
- React - UI библиотека
- TypeScript - типизация
- Zustand - управление состоянием
- Zustand Persist - персистентность состояния
- TailwindCSS - стилизация
- Lucide React - иконки

## Как запустить

### 1. Установка зависимостей

```bash
# Backend
pip install -r requirements.txt

# Frontend
cd frontend
npm install
```

### 2. Запуск сервера

```bash
# Из корневой директории
uvicorn src.server:app --reload
```

База данных создастся автоматически при первом запуске.

### 3. Запуск frontend

```bash
cd frontend
npm run dev
```

## Проверка работы

1. Откройте приложение в браузере
2. Выберите тип запроса (Вопрос/Квиз/Задание)
3. Отправьте сообщение
4. Диалог автоматически сохранится
5. Откройте боковую панель - увидите сохраненный диалог
6. Попробуйте создать новый диалог или загрузить существующий

## Примечания

- Все диалоги сохраняются локально в файле `conversations.db`
- User ID генерируется автоматически и сохраняется в localStorage браузера
- При очистке localStorage будет создан новый User ID
- Диалоги старого User ID останутся в БД, но не будут отображаться

## Возможные проблемы и решения

### База данных не создается
- Убедитесь, что у приложения есть права на запись в корневую директорию
- Проверьте, что SQLAlchemy установлен: `pip list | grep -i sqlalchemy`

### Диалоги не сохраняются
- Проверьте консоль браузера на наличие ошибок
- Убедитесь, что backend сервер запущен и доступен
- Проверьте, что CORS настроен правильно в `src/server.py`

### Боковая панель не открывается на мобильных
- Проверьте, что кнопка в левом верхнем углу видна
- Убедитесь, что z-index настроен правильно

## Следующие шаги

Возможные улучшения:
1. Поиск по диалогам
2. Редактирование заголовков
3. Фильтрация по типу и дате
4. Экспорт отдельных диалогов
5. Пагинация для большого количества диалогов
6. Аутентификация пользователей
7. Синхронизация между устройствами
